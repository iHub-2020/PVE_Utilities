# PVE 超强工具集 (PVE_Utilities)

兄弟们，这个仓库就是咱们 PVE 玩家的“军火库”。这里面放的都是我攒下来的、能一键解决大问题的牛逼脚本，目标就是把各种复杂、繁琐的 PVE 配置操作，变成一行命令搞定的爽快体验。

告别重复劳动，把时间留给更重要的事情！

---

## 1. PVE 网页 UI 增强脚本 (`pve-enhance.sh`)

这个脚本能给你的 PVE Web 界面开个“增强包”，让你在节点概要里直接看到所有关键的硬件状态，同时去掉那个烦人的订阅提示。

### 主要功能

*   **实时硬件监控**：在 PVE 节点概要页面直接显示 CPU 的**温度**、**实时频率**和**功耗 (Package Power)**。
*   **硬盘信息展示**：自动检测并展示所有 **NVMe** 和 **SATA (SSD/HDD)** 硬盘的型号、温度、通电时间和健康度信息。对于休眠中的机械硬盘，会智能地显示“休眠中”状态而不会将其唤醒。
*   **移除订阅提示**：彻底干掉每次登录都弹出来的“无有效订阅”提示框。
*   **智能适配**：脚本会自动检测 PVE 版本，动态调整 UI，并提供完善的备份与还原能力。

### 一键安装与执行

下面这行命令是“完全体”，它会先尝试从 GitHub 官方直接下载脚本，如果失败（比如网络问题），会自动切换到国内镜像下载。下载后赋予执行权限，并以 `remod` 模式运行，确保无论你是首次安装还是覆盖升级，都能一步到位。

直接在 PVE 的 Shell 中执行：

```bash
(curl -Lf -o /tmp/pve.sh https://raw.githubusercontent.com/iHub-2020/PVE_Utilities/main/pve-enhance.sh || curl -Lf -o /tmp/pve.sh https://mirror.ghproxy.com/https://raw.githubusercontent.com/iHub-2020/PVE_Utilities/main/pve-enhance.sh) && chmod +x /tmp/pve.sh && /tmp/pve.sh remod
```

执行完毕后，按 `Shift+F5` 强制刷新你的浏览器页面，就能看到效果了。

### 脚本参数说明

*   `bash /tmp/pve.sh`：首次安装时使用。
*   `bash /tmp/pve.sh remod`：**推荐使用**。强制重新安装，当你更新了脚本或者 PVE 版本后，用这个命令来覆盖更新。
*   `bash /tmp/pve.sh restore`：一键还原。如果你不想要这些功能了，执行此命令会彻底卸载脚本，将所有文件恢复到 PVE 的原始状态。

---

## 2. Intel 核显 SR-IOV 一键配置脚本 (`setup-i915-sriov.sh`)

这绝对是目前最智能、最省心的 Intel 核显 SR-IOV 配置脚本。无论是在 PVE 宿主机上，还是在 Debian/Ubuntu 虚拟机里，它都能帮你把所有繁琐的步骤全自动搞定。

### 核心特性

*   **全自动适配**：能自动判断自己是在 **PVE 宿主机** 还是 **虚拟机** 中运行，并执行不同的逻辑。
*   **动态版本探测**：
    *   自动从上游 GitHub 仓库获取**最新的 DKMS 驱动包**。
    *   自动解析上游项目的 `README` 文件，获取当前驱动**支持的 Linux 内核版本范围**。
*   **智能内核管理**：
    *   检查你当前的内核版本，如果不在支持范围内，会**提示并引导你自动升级**到最合适的版本。
    *   自动搜索并安装最匹配的内核头文件（`linux-headers`），这是 DKMS 编译的必备条件。
    *   提供**交互式的旧内核清理功能**，并允许你保留一个备用旧内核，非常安全。
*   **完整配置**：自动帮你配置好 `GRUB` 里的内核启动参数（如 `intel_iommu=on`），以及 `modprobe` 里的模块参数（如 `blacklist xe`, `max_vfs` 等）。
*   **交互式引导**：在关键步骤（如创建 VF 数量、配置模块参数）都会与你交互确认，让你完全掌控整个过程。
*   **终极安全**：在修改任何系统文件前，都会**自动创建备份**。一旦任何步骤出错，脚本会立即停止并**自动回滚所有文件修改**，最大限度保证你的系统安全。

### 一键启动

> **注意：** 这个脚本需要以 `root` 或 `sudo` 权限运行。下面的命令已经帮你处理好了。

同样，这条命令也包含了国内镜像作为备用下载路径。

```bash
(curl -Lf -o /tmp/sriov.sh https://raw.githubusercontent.com/iHub-2020/PVE_Utilities/main/setup-i915-sriov.sh || curl -Lf -o /tmp/sriov.sh https://mirror.ghproxy.com/https://raw.githubusercontent.com/iHub-2020/PVE_Utilities/main/setup-i915-sriov.sh) && chmod +x /tmp/sriov.sh && sudo /tmp/sriov.sh
```

### **【必读】重要执行流程说明**

这个脚本非常智能，请务必理解它的执行逻辑：

1.  **首次运行**：执行上面的命令后，脚本会开始工作。
2.  **内核检查**：它会检查你的内核版本。如果版本太旧，不符合驱动要求，脚本会提示你，并在你同意后，自动帮你安装一个新的内核。
3.  **自动退出**：内核安装完成后，脚本会**提示你需要重启，然后自动退出**。这是正常流程，因为新内核必须重启才能生效。
4.  **重启系统**：你按照提示，手动重启你的 PVE 主机或虚拟机。
5.  **再次运行**：系统重启并进入新内核后，你需要**再次执行上面那条一键启动的命令**。这一次，脚本会检测到内核版本已符合要求，然后继续完成后续的所有配置步骤。

简单说，整个过程最多需要你**执行两次同样的命令，中间重启一次系统**。

---
